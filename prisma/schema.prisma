generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                         String                 @id @default(uuid())
  email                      String                 @unique
  password                   String?
  fullName                   String
  createdAt                  DateTime               @default(now())
  updatedAt                  DateTime               @updatedAt
  dateOfBirth                DateTime?
  negativeRating             Int                    @default(0)
  positiveRating             Int                    @default(0)
  address                    String?
  avatar                     String?
  sellerExpiration           DateTime?
  paypalEmail                String?
  googleId                   String?                @unique
  profilePicture             String?
  provider                   String?
  role                       UserRole               @default(BIDDER)
  bids                       Bid[]
  favoriteProducts           FavoriteProduct[]
  Order_Order_buyerIdToUser  Order[]                @relation("Order_buyerIdToUser")
  Order_Order_sellerIdToUser Order[]                @relation("Order_sellerIdToUser")
  products                   Product[]
  questions                  Question[]
  ratingsGiven               Rating[]               @relation("RatingGiver")
  ratingsReceived            Rating[]               @relation("RatingReceiver")
  refreshTokens              RefreshToken[]
  upgradeRequests            SellerUpgradeRequest[]
  systemSettingsUpdated      SystemSettings[]
  messages Message[]
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model SellerUpgradeRequest {
  id        String        @id @default(uuid())
  userId    String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  status    UpgradeStatus @default(PENDING)
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Category {
  id          String     @id @default(uuid())
  name        String     @unique
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  parentId    String?
  description String?
  parent      Category?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryToCategory")
  products    Product[]
}

model Product {
  id                   String                   @id @default(uuid())
  name                 String
  description          String
  createdAt            DateTime                 @default(now())
  updatedAt            DateTime                 @updatedAt
  endTime              DateTime
  buyNowPrice          Float?
  autoExtend           Boolean                  @default(false)
  sellerId             String
  categoryId           String
  descriptionHistory   String[]
  images               String[]
  initialPrice         Float
  priceStep            Float
  winnerId             String?
  currentPrice         Float                    @default(0)
  status               ProductStatus            @default(ACTIVE)
  extendedCount        Int                      @default(0)
  originalEndTime      DateTime?
  startTime            DateTime
  searchVector         Unsupported("tsvector")?
  mainImage            String?
  allowNewBidders      Boolean                  @default(true)
  bids                 Bid[]
  favoriteBy           FavoriteProduct[]
  Order                Order?
  category             Category                 @relation(fields: [categoryId], references: [id])
  seller               User                     @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  questions            Question[]
  descriptionHistories DescriptionHistory[]

  @@index([sellerId])
  @@index([categoryId])
  @@index([status, endTime])
  @@index([searchVector], map: "idx_product_search_vector", type: Gin)
}

model SystemSettings {
  id                         String   @id @default(cuid())
  autoExtendThresholdMinutes Int      @default(5)
  extensionDuration          Int      @default(10)
  maxExtensions              Int?     @default(3)
  minImages                  Int      @default(3)
  updatedAt                  DateTime @updatedAt
  updatedBy                  String?
  updatedUser                User?    @relation(fields: [updatedBy], references: [id])

  @@map("system_settings")
}

model Bid {
  id        String   @id @default(uuid())
  amount    Float
  createdAt DateTime @default(now())
  userId    String
  productId String
  rejected  Boolean  @default(false)
  maxAmount Float?
  isProxy   Boolean  @default(false)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([productId])
  @@index([productId, maxAmount])
  @@index([productId, rejected, maxAmount])
}

model FavoriteProduct {
  id        String   @id @default(uuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
}

model Rating {
  id                                 String   @id @default(uuid())
  value                              Int
  comment                            String?
  createdAt                          DateTime @default(now())
  giverId                            String
  receiverId                         String
  Order_Order_buyerRatingIdToRating  Order?   @relation("Order_buyerRatingIdToRating")
  Order_Order_sellerRatingIdToRating Order?   @relation("Order_sellerRatingIdToRating")
  giver                              User     @relation("RatingGiver", fields: [giverId], references: [id], onDelete: Cascade)
  receiver                           User     @relation("RatingReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([giverId])
  @@index([receiverId])
}

model Question {
  id        String     @id @default(uuid())
  content   String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  productId String
  parentId  String?
  userId    String
  isDeleted Boolean    @default(false)
  parent    Question?  @relation("Thread", fields: [parentId], references: [id], onDelete: Cascade)
  children  Question[] @relation("Thread")
  product   Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([productId])
  @@index([parentId])
}

model DescriptionHistory {
  id          String   @id @default(uuid())
  description String
  createdAt   DateTime @default(now())
  productId   String
  createdBy   String?
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([createdAt])
  @@map("description_history")
}

model Order {
  id                                  String        @id
  productId                           String        @unique
  buyerId                             String
  sellerId                            String
  status                              OrderStatus   @default(PAYMENT_PENDING)
  paymentStatus                       PaymentStatus @default(PENDING)
  paymentAmount                       Float?
  paypalOrderId                       String?
  paypalTransactionId                 String?
  paidAt                              DateTime?
  platformFee                         Float?
  sellerAmount                        Float?
  sellerPaypalEmail                   String?
  payoutStatus                        PayoutStatus  @default(PENDING)
  payoutBatchId                       String?
  payoutItemId                        String?
  paidToSellerAt                      DateTime?
  shippingAddress                     String?
  shippingCity                        String?
  shippingDistrict                    String?
  shippingPhone                       String?
  shippingNote                        String?
  shippingSubmittedAt                 DateTime?
  sellerConfirmedAt                   DateTime?
  trackingNumber                      String?
  shippingCarrier                     String?
  shippedAt                           DateTime?
  buyerConfirmedAt                    DateTime?
  receivedAt                          DateTime?
  isCancelled                         Boolean       @default(false)
  cancelledAt                         DateTime?
  cancelledBy                         String?
  cancellationReason                  String?
  buyerRatingId                       String?       @unique
  sellerRatingId                      String?       @unique
  createdAt                           DateTime      @default(now())
  updatedAt                           DateTime
  User_Order_buyerIdToUser            User          @relation("Order_buyerIdToUser", fields: [buyerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Rating_Order_buyerRatingIdToRating  Rating?       @relation("Order_buyerRatingIdToRating", fields: [buyerRatingId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Product                             Product       @relation(fields: [productId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  User_Order_sellerIdToUser           User          @relation("Order_sellerIdToUser", fields: [sellerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Rating_Order_sellerRatingIdToRating Rating?       @relation("Order_sellerRatingIdToRating", fields: [sellerRatingId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  chat                                Chat?

  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
}

model Chat {
  id        String    @id @default(uuid())
  orderId   String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  order     Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@index([orderId])
}

model Message {
  id        String   @id @default(uuid())
  chatId    String
  senderId  String
  content   String
  createdAt DateTime @default(now())
  isRead    Boolean  @default(false)
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender    User     @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([chatId, createdAt])
  @@index([senderId])
} 

enum UserRole {
  BIDDER
  SELLER
  ADMIN
  GUEST
}

enum UpgradeStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum ProductStatus {
  ACTIVE
  COMPLETED
  CANCELED
}

enum OrderStatus {
  PAYMENT_PENDING
  SHIPPING_INFO_PENDING
  SELLER_CONFIRMATION_PENDING
  IN_TRANSIT
  BUYER_CONFIRMATION_PENDING
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}
